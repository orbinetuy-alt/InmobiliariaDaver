<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Propiedades - Daver Inmobiliaria</title>
  <link rel="stylesheet" href="css/styles.css">
  <link rel="icon" href="assets/logo.png" type="image/png">
</head>
<body>
  <header class="site-header">
    <div class="container">
      <h1 class="brand">
        <img src="assets/logo.png" alt="Daver Inmobiliaria" class="header-logo">
      </h1>
      <nav class="main-nav" id="mainNav">
        <a href="index.html">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12l9-9 9 9h-2v7a2 2 0 01-2 2H7a2 2 0 01-2-2v-7H3z"/>
          </svg>
          Inicio
        </a>
        <a href="listings.html">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
            <path d="M9 22V12h6v10"/>
          </svg>
          Propiedades
        </a>
        <a href="nosotros.html">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          Nosotros
        </a>
        <a href="ubicacion.html">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
            <circle cx="12" cy="10" r="3"/>
          </svg>
          Ubicación
        </a>
        <a href="contacto.html">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
            <path d="M22 6l-10 7L2 6"/>
          </svg>
          Contacto
        </a>
      </nav>
      <button class="nav-toggle" id="navToggle" aria-controls="mainNav" aria-expanded="false" aria-label="Abrir menú">
        <svg width="26" height="26" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path class="line line1" d="M3 6h18" stroke="#222" stroke-width="2" stroke-linecap="round" />
          <path class="line line2" d="M3 12h18" stroke="#222" stroke-width="2" stroke-linecap="round" />
          <path class="line line3" d="M3 18h18" stroke="#222" stroke-width="2" stroke-linecap="round" />
        </svg>
      </button>
    </div>
  </header>

  <div class="listing-header">
    <div class="container">
      <div class="listing-meta">
        <div>
          <h2 id="listingTitle">Propiedades</h2>
          <span id="resultsCount" class="listing-count">24 propiedades</span>
        </div>
        <div class="listing-sort">
          <span>Ordenar por:</span>
          <select id="sort" class="filter-select">
            <option value="destacados">Destacados</option>
            <option value="recientes">Más recientes</option>
            <option value="precio-asc">Menor precio</option>
            <option value="precio-desc">Mayor precio</option>
          </select>
        </div>
      </div>

      <div class="filter-bar">
        <div class="filter-group">
          <label class="filter-label">Tipo de propiedad</label>
          <select id="propertyType" class="filter-select">
            <option value="">Todas</option>
            <option value="apartamento">Apartamentos</option>
            <option value="casa">Casas</option>
            <option value="oficina">Oficinas</option>
            <option value="terreno">Terrenos</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Tipo de operación</label>
          <select id="operation" class="filter-select">
            <option value="">Todos</option>
            <option value="venta">En venta</option>
            <option value="alquiler">En alquiler</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">Zona</label>
          <select id="zone" class="filter-select">
            <option value="">Todas las zonas</option>
            <option value="aguada">Aguada</option>
            <option value="barrio-sur">Barrio Sur</option>
            <option value="capurro">Capurro Bella Vista</option>
            <option value="carrasco">Carrasco</option>
            <option value="centro">Centro</option>
            <option value="ciudad-vieja">Ciudad Vieja</option>
            <option value="cordon">Cordón</option>
            <option value="la-blanqueada">La Blanqueada</option>
            <option value="la-comercial">La Comercial</option>
            <option value="la-figurita">La Figurita</option>
            <option value="palermo">Palermo</option>
            <option value="pocitos">Pocitos</option>
            <option value="punta-carretas">Punta Carretas</option>
            <option value="tres-cruces">Tres Cruces</option>
            <option value="union">Unión</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">Dormitorios</label>
          <select id="bedrooms" class="filter-select">
            <option value="">Cualquiera</option>
            <option value="1">1 dormitorio</option>
            <option value="2">2 dormitorios</option>
            <option value="3">3 dormitorios</option>
            <option value="4">4 o más</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">Precio</label>
          <select id="price" class="filter-select">
            <option value="">Cualquier precio</option>
            <option value="0-50000">Hasta USD 50.000</option>
            <option value="50000-100000">USD 50.000 - 100.000</option>
            <option value="100000-200000">USD 100.000 - 200.000</option>
            <option value="200000-plus">Más de USD 200.000</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <main class="container">
    <div class="grid listings listings-page" id="listings">
      <!-- Las propiedades se cargarán dinámicamente desde Firebase -->
      <div style="text-align: center; padding: 60px 20px;">
        <div class="loading-spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
        <p style="color: #666;">Cargando propiedades...</p>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container">
      <p>&copy; <span id="year"></span> Daver Inmobiliaria — Todos los derechos reservados.</p>
    </div>
  </footer>


  <!-- Script.js NO se carga aquí porque listings.html usa Firebase con su propio sistema de filtrado -->
  <!-- <script src="js/script.js"></script> -->
  
  <!-- Código básico: año en footer y menú móvil -->
  <script>
    // Año en footer
    document.getElementById('year').textContent = new Date().getFullYear();
    
    // Toggle menú móvil
    var navToggle = document.getElementById('navToggle');
    var mainNav = document.getElementById('mainNav');
    if(navToggle && mainNav){
      var backdrop = document.createElement('div');
      backdrop.className = 'nav-backdrop';
      document.body.appendChild(backdrop);

      function closeNav(){
        mainNav.classList.remove('open');
        navToggle.classList.remove('open');
        navToggle.setAttribute('aria-expanded','false');
        backdrop.classList.remove('show');
      }

      function openNav(){
        mainNav.classList.add('open');
        navToggle.classList.add('open');
        navToggle.setAttribute('aria-expanded','true');
        backdrop.classList.add('show');
      }

      navToggle.addEventListener('click', function(e){
        e.stopPropagation();
        if(mainNav.classList.contains('open')) closeNav(); else openNav();
      });

      document.addEventListener('keydown', function(e){
        if(e.key === 'Escape' && mainNav.classList.contains('open')){
          closeNav();
        }
      });

      backdrop.addEventListener('click', function(){
        closeNav();
      });

      mainNav.addEventListener('click', function(e){
        if(e.target && e.target.tagName === 'A'){
          closeNav();
        }
      });
    }
  </script>
  
  <!-- AI Search Results Handler -->
  <script src="js/ai-search-results.js"></script>
  
  <!-- Firebase Loader - Cargar propiedades dinámicamente -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { formatPrice } from './js/firebase-loader.js';
    
    const firebaseConfig = {
      apiKey: "AIzaSyCj6nyM8iqeXLEPNp46M_j-CW7aCTYM60A",
      authDomain: "daver-inmobiliaria-65e82.firebaseapp.com",
      projectId: "daver-inmobiliaria-65e82",
      storageBucket: "daver-inmobiliaria-65e82.firebasestorage.app",
      messagingSenderId: "936144386163",
      appId: "1:936144386163:web:10b999ab6dcc9456bcd206"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // Cargar propiedades al iniciar
    async function loadProperties() {
      try {
        const container = document.getElementById('listings');
        const querySnapshot = await getDocs(collection(db, 'properties'));
        
        if (querySnapshot.empty) {
          showEmpty();
          return;
        }
        
        // Limpiar container
        container.innerHTML = '';
        
        querySnapshot.forEach((doc) => {
          const property = { id: doc.id, ...doc.data() };
          const card = createPropertyElement(property);
          container.appendChild(card);
        });
        
        updateResultsCount(querySnapshot.size);
        makeCardsClickable();
        
        // DESPUÉS de cargar propiedades, aplicar filtros de URL
        applyFiltersFromUrl();
      } catch (error) {
        console.error('Error al cargar propiedades:', error);
        showError();
      }
    }
    
    // Crear elemento de propiedad (igual que test-simple.html que funciona)
    function createPropertyElement(property) {
      const operationText = property.operation === 'venta' ? 'En venta' : 'En alquiler';
      const mainImage = property.images && property.images[0] ? property.images[0] : 'assets/placeholder.svg';
      
      const article = document.createElement('article');
      article.className = 'card';
      
      // CRÍTICO: Usar setAttribute como en test-simple.html
      article.setAttribute('data-type', property.type || '');
      article.setAttribute('data-operation', property.operation || '');
      article.setAttribute('data-zone', property.neighborhood || '');
      article.setAttribute('data-bedrooms', property.bedrooms || '');
      article.setAttribute('data-price', property.price || 0);
      article.setAttribute('data-property-id', property.id);
      
      article.innerHTML = `
        <div class="card-img-wrapper">
          <img src="${mainImage}" alt="${property.title}" loading="lazy" onerror="this.src='assets/placeholder.svg'">
          <span class="card-tag">${operationText}</span>
        </div>
        <div class="card-content">
          <h4>${property.title}</h4>
          <address class="card-location">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/>
              <circle cx="12" cy="9" r="2.5"/>
            </svg>
            ${property.neighborhood}, Montevideo
          </address>
          <div class="card-features">
            ${property.bedrooms ? `
              <span>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                </svg>
                ${property.bedrooms} dorm
              </span>
            ` : ''}
            ${property.bathrooms ? `
              <span>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 12h-3m3 0v7h-18v-7M21 12V5h-18v7m18 0h-18"/>
                </svg>
                ${property.bathrooms} ${property.bathrooms === 1 ? 'baño' : 'baños'}
              </span>
            ` : ''}
            ${property.area ? `
              <span>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M4 4h16v16H4z"/>
                </svg>
                ${property.area} m²
              </span>
            ` : ''}
          </div>
          <p class="price">${formatPrice(property.price, property.currency)}</p>
        </div>
      `;
      
      return article;
    }
    
    // Mostrar estado vacío
    function showEmpty() {
      const container = document.getElementById('listings');
      container.innerHTML = `
        <div style="text-align: center; padding: 60px 20px;">
          <svg width="80" height="80" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: #ccc; margin: 0 auto 20px;">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
          </svg>
          <h3 style="color: #555; margin: 0 0 10px 0;">No se encontraron propiedades</h3>
          <p style="color: #999; margin: 0;">Intenta ajustar los filtros de búsqueda</p>
        </div>
      `;
    }
    
    // Mostrar error
    function showError() {
      const container = document.getElementById('listings');
      container.innerHTML = `
        <div style="text-align: center; padding: 60px 20px;">
          <p style="color: #e74c3c;">Error al cargar las propiedades. Por favor recarga la página.</p>
        </div>
      `;
    }
    
    // Actualizar contador de resultados
    function updateResultsCount(count) {
      const countElement = document.getElementById('resultsCount');
      if (countElement) {
        countElement.textContent = `${count} ${count === 1 ? 'propiedad' : 'propiedades'}`;
      }
    }
    
    // Hacer cards clicables
    function makeCardsClickable() {
      const cards = document.querySelectorAll('.listings .card');
      
      cards.forEach(card => {
        card.style.cursor = 'pointer';
        
        card.addEventListener('click', function() {
          const propertyId = this.getAttribute('data-property-id');
          if (propertyId) {
            window.location.href = `property-detail.html?id=${propertyId}`;
          }
        });
        
        card.addEventListener('mouseenter', function() {
          this.style.transform = 'translateX(4px)';
        });
        
        card.addEventListener('mouseleave', function() {
          this.style.transform = 'translateX(0)';
        });
      });
    }
    
    // Aplicar filtros (COPIADO EXACTAMENTE de test-simple.html que funciona)
    function applyFilters() {
      const cards = document.querySelectorAll('.listings .card');
      
      if (!cards.length) {
        console.log('⚠️ No hay tarjetas para filtrar');
        return;
      }

      const propertyType = document.getElementById('propertyType').value.trim();
      const operation = document.getElementById('operation').value.trim();
      const zone = document.getElementById('zone').value.trim();
      const bedrooms = document.getElementById('bedrooms').value.trim();

      console.clear();
      console.log('═══════════════════════════════════');
      console.log('Filtro propertyType:', `"${propertyType}"`);
      console.log('Filtro operation:', `"${operation}"`);
      console.log('Filtro zone:', `"${zone}"`);
      console.log('Filtro bedrooms:', `"${bedrooms}"`);
      console.log('Total de tarjetas:', cards.length);
      console.log('═══════════════════════════════════');

      let visibleCount = 0;

      cards.forEach((card, i) => {
        const cardType = card.getAttribute('data-type') || '';
        const cardOperation = card.getAttribute('data-operation') || '';
        const cardZone = card.getAttribute('data-zone') || '';
        const cardBedrooms = card.getAttribute('data-bedrooms') || '';

        const matchType = propertyType === '' || cardType === propertyType;
        const matchOperation = operation === '' || cardOperation === operation;
        const matchZone = zone === '' || cardZone === zone;
        const matchBedrooms = bedrooms === '' || cardBedrooms === bedrooms;

        const matches = matchType && matchOperation && matchZone && matchBedrooms;

        if (i < 3) {
          console.log(`Tarjeta ${i + 1}:`);
          console.log(`  data-type: "${cardType}" | match: ${matchType}`);
          console.log(`  data-operation: "${cardOperation}" | match: ${matchOperation}`);
          console.log(`  data-zone: "${cardZone}" | match: ${matchZone}`);
          console.log(`  data-bedrooms: "${cardBedrooms}" | match: ${matchBedrooms}`);
          console.log(`  VISIBLE: ${matches}`);
          console.log('');
        }

        if (matches) {
          card.style.display = '';
          visibleCount++;
        } else {
          card.style.display = 'none';
        }
      });

      console.log('═══════════════════════════════════');
      console.log(`✅ RESULTADO: ${visibleCount} de ${cards.length} visibles`);
      console.log('═══════════════════════════════════');

      updateResultsCount(visibleCount);
    }
    
    // Aplicar filtros desde URL (COPIADO de script.js que funcionaba)
    function applyFiltersFromUrl() {
      var params = new URLSearchParams(window.location.search);
      var type = params.get('type');
      
      // Establecer valores de los filtros
      if (document.getElementById('propertyType')) {
        document.getElementById('propertyType').value = type || '';
      }
      if (document.getElementById('operation')) {
        document.getElementById('operation').value = params.get('operation') || '';
      }
      if (document.getElementById('zone')) {
        document.getElementById('zone').value = params.get('zone') || '';
      }
      if (document.getElementById('bedrooms')) {
        document.getElementById('bedrooms').value = params.get('bedrooms') || '';
      }
      
      // Si hay algún parámetro, aplicar filtros
      if (type || params.get('operation') || params.get('zone') || params.get('bedrooms')) {
        applyFilters();
      }
    }
    
    // Cargar al inicio
    loadProperties();
    
    // Event listeners para filtros
    document.getElementById('propertyType').addEventListener('change', applyFilters);
    document.getElementById('operation').addEventListener('change', applyFilters);
    document.getElementById('zone').addEventListener('change', applyFilters);
    document.getElementById('bedrooms').addEventListener('change', applyFilters);
  </script>
  
</body>
</html>